name: CI Pipeline

on: [push]

env:
  IMAGE_TAG: web-calculator:${{ github.sha }}
  APP_START_TIMEOUT: 60

jobs:
  # -------------
  # Build
  # -------------
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ env.IMAGE_TAG }}
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t $IMAGE_TAG .

  # -------------
  # Unit tests
  # -------------
  unit_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run unit tests
        run: |
          pip install -r requirements.txt
          python -m pytest tests/unit_tests/ -v --junitxml=unit-results.xml
      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: unit-results.xml

  # -------------
  # Functional tests
  # -------------
  functional_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Install Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      - name: Build and start application
        run: |
          docker build -t ${{ needs.build.outputs.image_tag }} .
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout $APP_START_TIMEOUT bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Run functional tests
        run: |
          pip install -r requirements.txt
          python -m pytest tests/functional_tests/ --url=http://localhost:5000 -v --junitxml=functional-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: functional-test-results
          path: functional-results.xml
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Curl tests
  # -------------
  curl_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Build and start application
        run: |
          docker build -t ${{ needs.build.outputs.image_tag }} .
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout $APP_START_TIMEOUT bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Run curl tests
        run: |
          {
            echo "ðŸ§ª Running curl tests..."
            echo "=========================="
            curl -f http://localhost:5000/ && echo "âœ… Root OK"
            curl -f "http://localhost:5000/add/2&3" && echo "âœ… Add OK"
            curl -f "http://localhost:5000/multiply/3&4" && echo "âœ… Multiply OK"
            curl -f "http://localhost:5000/subtract/10&4" && echo "âœ… Subtract OK"
            curl -f "http://localhost:5000/divide/20&5" && echo "âœ… Divide OK"
            echo "=========================="
            echo "ðŸŽ‰ All curl tests passed!"
          } > curl-report.txt
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: curl-test-results
          path: curl-report.txt
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Package release
  # -------------
  package_release:
    runs-on: ubuntu-latest
    needs: [unit_tests, functional_tests, curl_tests]
    steps:
      - uses: actions/checkout@v4
      - name: Create release package
        run: |
          zip -r web-calculator-release.zip . -x "*.git*" "*.github*" "*.pytest_cache*" "__pycache__/*"
      - name: Upload release
        uses: actions/upload-artifact@v4
        with:
          name: web-calculator-release
          path: web-calculator-release.zip

  # -------------
  # CD - Deploy via SSH
  # -------------
  deploy:
    runs-on: ubuntu-latest
    needs: [package_release]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/hassan/web-calculator/blue-green-deployment
            ./deploy.sh